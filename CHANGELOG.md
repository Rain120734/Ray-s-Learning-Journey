# FTC DECODE 自動計分系統開發紀錄

## 專案說明

FTC DECODE 2025-2026 賽季自動計分程式，透過影片分析偵測場上的紫色和綠色球，自動計算得分。

---

## 2025/12/21 - 專案開始

決定用 OpenCV 做影像處理。一開始考慮過 YOLO，但需要標註資料太麻煩，FTC 的球顏色很鮮明，用 HSV 顏色偵測應該夠用。

建好 Maven 專案，設定 OpenCV 4.9.0。定義了基本的資料結構：ArtifactType（球的類型）、Alliance（紅藍方）、DetectedArtifact（偵測到的物件）。

---

## 2025/12/24 - 顏色偵測實作

花了不少時間調 HSV 參數。紫色的範圍比想像中難抓，從偏粉到偏藍都有。綠色相對簡單，但要小心排除場地上其他綠色物體。

第一版參數：
```
紫色: H=140-170, S=50-255, V=50-255
綠色: H=40-80, S=50-255, V=50-255
```

問題：偵測到太多雜訊，不是球的東西也被抓到。

---

## 2025/12/27 - AprilTag 定位

場地上有 AprilTag 可以用來定位坡道位置。Tag 20 是藍方那邊，Tag 24 是紅方。這樣就不用手動設定偵測區域了。

同步開始做計分引擎 ScoringEngine：
- CLASSIFIED: 球進坡道得 3 分
- 坡道最多 9 顆球
- 超過就 OVERFLOW

---

## 2025/12/30 - 球追蹤器

這個最難搞。如果每偵測到球就計分，同一顆球會被算好幾次。

做了 BallTracker，用最近鄰匹配法追蹤同一顆球。設定 MAX_DISTANCE=60，超過這個距離就當作不同球。

還是有問題：球移動快的時候追蹤會斷掉，然後被當成新球又計一次分。

---

## 2026/01/02 - 輪廓處理優化

處理多顆球黏在一起的狀況。設定單球面積約 2500 像素，超過 2.2 倍就嘗試分割。

加了圓形度過濾，circularity < 0.35 的不算球。長寬比太誇張的（< 0.5 或 > 2.0）也排除。

調高追蹤距離到 100，遺失幀數容忍度從 30 調到 45，追蹤比較穩定了。

---

## 2026/01/05 - UI 和坡道改進

用 Swing 做 UI，功能：
- 載入影片、播放暫停
- 進度條
- 紅藍方分數面板
- 事件記錄

發現矩形坡道區域不夠精確，實際坡道是斜的。改用 4 點多邊形定義，用 pointPolygonTest 判斷點是否在區域內。

加了自動清空功能，坡道裡 0.5 秒沒偵測到球就清空顯示。

---

## 2026/01/08 - 手動標註和最後修正

AprilTag 自動算的位置有時不準。做了手動標註功能，讓使用者點 4 個角點定義坡道區域。載入影片後要先標註完才能播放。

發現一個 bug：綠球有時被記成紫色。查了一下是追蹤匹配時沒考慮球的類型，綠球被配對到旁邊的紫色偵測結果。

修正方式：
1. 匹配時優先選同類型的球（不同類型加 200 距離懲罰）
2. 追蹤過程中不改變球的類型

---

## 技術細節

### 最終參數
```
紫色 HSV: (125,45,55) - (175,255,255)
綠色 HSV: (35,60,50) - (100,255,255)
最小圓形度: 0.35
最小面積: 500
追蹤距離: 100
```

### 架構
- ArtifactDetector: 顏色偵測
- AprilTagDetector: AprilTag 定位
- BallTracker: 球追蹤
- ScoringEngine: 計分邏輯
- FTCMainWindow: UI 和主控

---

## 待改進

- 考慮用機器學習提升偵測準確度
- 支援即時串流
- 匯出比賽數據
